<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <link rel="icon" href="data:;base64,=">
<meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø®ØµÙŠØ© (Ù…Ø­Ù„ÙŠ - LocalStorage)</title>
  <style>
    :root{
      /* Bright + calm palette */
      --bg:#f6f8ff;
      --panel:#ffffff;
      --card:#ffffff;
      --muted:#667085;
      --text:#101828;
      --brand:#2e6cff;
      --brand2:#00bfa6;
      --danger:#e5484d;
      --warn:#f59f00;
      --ok:#12b76a;
      --border:rgba(16,24,40,.10);
      --shadow: 0 10px 30px rgba(16,24,40,.08);
      --radius:18px;
      --radius2:14px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Tahoma, Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 10% 0%, rgba(46,108,255,.12), transparent 55%),
        radial-gradient(1000px 800px at 95% 10%, rgba(0,191,166,.10), transparent 50%),
        radial-gradient(900px 700px at 40% 110%, rgba(245,159,0,.08), transparent 45%),
        var(--bg);
      color:var(--text);
      font-family:var(--font);
      line-height:1.45;
    }
    a{color:inherit}
    .app{
      max-width: 1150px;
      margin: 0 auto;
      padding: 18px 14px 26px;
    }
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      padding: 14px 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.86);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:sticky;
      top:10px;
      z-index:5;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 260px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(46,108,255,.95), rgba(0,191,166,.90));
      display:grid;place-items:center;
      box-shadow: 0 12px 22px rgba(46,108,255,.18);
      color:white;
      font-weight:900;
    }
    .brand h1{
      font-size:16px;margin:0;
      letter-spacing:.2px;
    }
    .brand p{
      margin:0;color:var(--muted);font-size:12px
    }
    .controls{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .chip{
      display:flex;gap:8px;align-items:center;
      padding:8px 10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.72);
      border-radius: 999px;
      color:var(--muted);
      font-size:12px;
    }
    .chip input{
      background:transparent;border:0;color:var(--text);
      outline:none;font-family:var(--font);
    }
    input[type="month"], input[type="date"], input[type="number"], input[type="text"], textarea, select{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(16,24,40,.14);
      background: rgba(255,255,255,.92);
      color: var(--text);
      outline:none;
      font-family:var(--font);
    }
    input::placeholder, textarea::placeholder{color: rgba(102,112,133,.85)}
    textarea{min-height:90px;resize:vertical}
    select{cursor:pointer}
    .btn{
      border:1px solid rgba(16,24,40,.14);
      background: rgba(255,255,255,.90);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
      font-family:var(--font);
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      user-select:none;
      white-space:nowrap;
      box-shadow: 0 8px 18px rgba(16,24,40,.06);
    }
    .btn:hover{
      background: rgba(255,255,255,1);
      border-color: rgba(46,108,255,.25);
      box-shadow: 0 10px 22px rgba(46,108,255,.10);
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(46,108,255,.95), rgba(0,191,166,.88));
      border-color: transparent;
      color:white;
      font-weight:800;
      box-shadow: 0 14px 26px rgba(46,108,255,.18);
    }
    .btn.primary:hover{box-shadow: 0 16px 30px rgba(46,108,255,.22)}
    .btn.danger{
      background: rgba(229,72,77,.10);
      border-color: rgba(229,72,77,.22);
      color: #b42318;
      box-shadow: 0 8px 18px rgba(229,72,77,.08);
    }
    .btn.danger:hover{border-color: rgba(229,72,77,.30)}
    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }
    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;
      margin-top: 14px;
      padding: 10px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.70);
      box-shadow: var(--shadow);
    }
    .tab{
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid transparent;
      cursor:pointer;
      color: var(--muted);
      background: transparent;
      user-select:none;
      font-size:13px;
      display:flex;gap:8px;align-items:center;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(46,108,255,.25);
      background: rgba(46,108,255,.10);
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      margin-top: 14px;
    }
    .card{
      grid-column: span 12;
      border:1px solid var(--border);
      background: rgba(255,255,255,.82);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;
      border-bottom:1px solid rgba(16,24,40,.08);
    }
    .card .hd h2{margin:0;font-size:14px}
    .card .hd p{margin:4px 0 0;color:var(--muted);font-size:12px}
    .card .bd{padding: 14px}
    .kpis{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .kpi{
      grid-column: span 12;
      border:1px solid rgba(16,24,40,.10);
      background: rgba(255,255,255,.92);
      border-radius: var(--radius2);
      padding: 12px;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      box-shadow: 0 8px 18px rgba(16,24,40,.05);
    }
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:18px;font-weight:900}
    .kpi .hint{color:var(--muted);font-size:11px;margin-top:2px}
    .pill{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(16,24,40,.14);
      color: var(--muted);
      background: rgba(255,255,255,.92);
      white-space:nowrap;
    }
    .pill.ok{border-color: rgba(18,183,106,.25); background: rgba(18,183,106,.10); color:#067647}
    .pill.warn{border-color: rgba(245,159,0,.28); background: rgba(245,159,0,.10); color:#7a4c00}
    .pill.danger{border-color: rgba(229,72,77,.28); background: rgba(229,72,77,.10); color:#b42318}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.end{justify-content:flex-end}
    .muted{color:var(--muted)}
    .split{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
    }
    @media (max-width: 900px){
      .split{grid-template-columns: 1fr}
    }
    @media (min-width: 720px){
      .kpi{grid-column: span 6}
    }
    @media (min-width: 980px){
      .kpi{grid-column: span 3}
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid rgba(16,24,40,.10);
      border-radius: 14px;
      background: rgba(255,255,255,.92);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(16,24,40,.08);
      vertical-align: top;
      font-size: 13px;
    }
    th{
      color: rgba(102,112,133,.95);
      font-weight: 800;
      text-align:right;
      background: rgba(46,108,255,.06);
    }
    tr:last-child td{border-bottom:0}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(16,24,40,.12);
      background: rgba(46,108,255,.06);
      font-size: 12px;
      color: rgba(52,64,84,.92);
    }
    .money.pos{color:#067647}
    .money.neg{color:#b42318}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .btn.small{padding:8px 10px;border-radius:12px;font-size:12px}
    .btn.icon{padding:8px 10px;border-radius:12px}
    .hr{height:1px;background:rgba(16,24,40,.10); margin: 12px 0}
    .mini{
      font-size: 12px;
      color: var(--muted);
    }
    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width:720px){.two{grid-template-columns:1fr}}
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: rgba(16,24,40,.35);
      backdrop-filter: blur(6px);
      z-index: 20;
    }
    .modal.open{display:flex}
    .dialog{
      width:min(760px, 100%);
      border:1px solid rgba(16,24,40,.14);
      background: rgba(255,255,255,.96);
      border-radius: 20px;
      box-shadow: 0 18px 40px rgba(16,24,40,.14);
      overflow:hidden;
    }
    .dialog .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(16,24,40,.10);
      display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;
    }
    .dialog .hd h3{margin:0;font-size:14px}
    .dialog .bd{padding: 14px}
    .dialog .ft{
      padding: 14px;
      border-top: 1px solid rgba(16,24,40,.10);
      display:flex;gap:10px;justify-content:flex-start;flex-wrap:wrap;
    }
    .help{
      background: rgba(46,108,255,.08);
      border:1px solid rgba(46,108,255,.18);
      padding:10px 12px;
      border-radius: 14px;
      color:#1d4ed8;
      font-size: 12px;
    }
    canvas{
      width:100%;
      height:260px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(16,24,40,.10);
      border-radius: 14px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px;
      padding:3px 6px;
      border-radius:8px;
      border:1px solid rgba(16,24,40,.14);
      background: rgba(255,255,255,.92);
      color: rgba(102,112,133,.95);
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo">â‚ </div>
        <div>
          <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø®ØµÙŠØ©</h1>
          <p>ÙŠØ¹Ù…Ù„ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (GitHub Pages) Ù…Ø¹ Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ (Firebase) â€” ÙˆÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª</p>
        </div>
      </div>

      <div class="controls">
        <div class="chip" title="Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ù„ÙŠÙ‡">
          <span>Ø§Ù„Ø´Ù‡Ø±:</span>
          <input id="monthPicker" type="month" />
        </div>

        <button class="btn primary" id="btnAddTx">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©</button>
        <button class="btn" id="btnExport">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
        <button class="btn" id="btnImport">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
        <button class="btn" id="btnCloud">â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©</button>
      <span class="pill" id="cloudBadge">â˜ï¸ ØºÙŠØ± Ù…ØªØµÙ„</span>
</div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="dash">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      <div class="tab" data-tab="tx">ğŸ§¾ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
      <div class="tab" data-tab="budgets">ğŸ§© ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</div>
      <div class="tab" data-tab="reports">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
      <div class="tab" data-tab="settings">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>

    <!-- DASHBOARD -->
    <section id="view-dash" class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h2>Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±</h2>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙˆØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</p>
          </div>
          <div class="row">
            <span class="pill" id="pillStatus">â€”</span>
          </div>
        </div>
        <div class="bd">
          <div class="kpis">
            <div class="kpi">
              <div>
                <div class="label">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                <div class="value" id="kpiIncome">â€”</div>
                <div class="hint">Ù…Ø¬Ù…ÙˆØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±</div>
              </div>
              <span class="tag">ğŸ’°</span>
            </div>
            <div class="kpi">
              <div>
                <div class="label">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
                <div class="value" id="kpiExpense">â€”</div>
                <div class="hint">Ù…Ø¬Ù…ÙˆØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµØ±Ù Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±</div>
              </div>
              <span class="tag">ğŸ§¾</span>
            </div>
            <div class="kpi">
              <div>
                <div class="label">Ø§Ù„ØµØ§ÙÙŠ</div>
                <div class="value" id="kpiNet">â€”</div>
                <div class="hint">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª âˆ’ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
              </div>
              <span class="tag">ğŸ§®</span>
            </div>
            <div class="kpi">
              <div>
                <div class="label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</div>
                <div class="value" id="kpiSavingRate">â€”</div>
                <div class="hint">Ø§Ù„ØµØ§ÙÙŠ Ã· Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
              </div>
              <span class="tag">ğŸ¦</span>
            </div>
          </div>

          <div class="hr"></div>

          <div class="split">
            <div>
              <div class="row" style="justify-content:space-between">
                <div>
                  <div style="font-weight:800;margin-bottom:4px">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ</div>
                  <div class="mini">ÙŠØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ù…Ø¹Ø±ÙØ© â€œØ£ÙŠÙ† ØªØ°Ù‡Ø¨ Ø§Ù„Ø£Ù…ÙˆØ§Ù„â€</div>
                </div>
                <div class="row">
                  <span class="kbd">Reports</span>
                  <span class="mini">Ù„ØªØ­Ù„ÙŠÙ„ Ø£Ø¹Ù…Ù‚</span>
                </div>
              </div>
              <div style="margin-top:10px">
                <canvas id="pieExpense"></canvas>
              </div>
            </div>
            <div>
              <div style="font-weight:800;margin-bottom:4px">Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø©</div>
              <div class="mini">Ø¥ÙŠØ±Ø§Ø¯ Ù…Ù‚Ø§Ø¨Ù„ Ù…ØµØ±ÙˆÙ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±</div>
              <div style="margin-top:10px">
                <canvas id="barIncomeExpense"></canvas>
              </div>
              <div class="help" style="margin-top:12px">
                <div><b>Ù†ØµÙŠØ­Ø© Ø¹Ù…Ù„ÙŠØ©:</b> Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø´Ù‡Ø± Ù…Ù† ØªØ¨ÙˆÙŠØ¨ <b>ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</b> ÙˆØ­Ø¯Ø¯ â€œØ¯Ø®Ù„ Ù…Ø®Ø·Ø·â€ Ø«Ù… ÙˆØ²Ù‘Ø¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª (Ø¥ÙŠØ¬Ø§Ø±ØŒ Ø¯ÙŠÙ†ØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ Ù…Ø´ØªØ±ÙŠØ§Øª...).</div>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <div style="font-weight:800;margin-bottom:4px">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„ØªÙŠ ØªØ¬Ø§ÙˆØ²Øª Ù…ÙŠØ²Ø§Ù†ÙŠØªÙ‡Ø§</div>
              <div class="mini">ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø£ÙŠ ØªØµÙ†ÙŠÙ ØªØ®Ø·Ù‘Ù‰ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø®Ø·Ø· Ù„Ù‡ Ù„Ù„Ø´Ù‡Ø±</div>
            </div>
            <button class="btn small" id="btnGoBudgets">ğŸ§© ÙØªØ­ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</button>
          </div>
          <div style="margin-top:10px" id="overspendList" class="mini">â€”</div>
        </div>
      </div>
    </section>

    <!-- TRANSACTIONS -->
    <section id="view-tx" class="grid" style="display:none">
      <div class="card">
        <div class="hd">
          <div>
            <h2>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¥ÙŠØ±Ø§Ø¯Ø§Øª / Ù…ØµØ§Ø±ÙŠÙ)</h2>
            <p>Ø£Ø¶Ù Ø£ÙŠ Ù…ØµØ±ÙˆÙ Ø£Ùˆ Ø¥ÙŠØ±Ø§Ø¯ Ù…Ø¹ ØªØ§Ø±ÙŠØ® ÙŠØ¯ÙˆÙŠ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø© ÙˆØªØµÙ†ÙŠÙ Ù…Ø±Ù†.</p>
          </div>
          <div class="row">
            <button class="btn small" id="btnCategories">ğŸ·ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</button>
            <button class="btn small" id="btnAddTx2">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©</button>
          </div>
        </div>
        <div class="bd">
          <div class="two">
            <div class="row">
              <select id="filterType">
                <option value="">Ø§Ù„ÙƒÙ„ (Ø¥ÙŠØ±Ø§Ø¯ + Ù…ØµØ±ÙˆÙ)</option>
                <option value="income">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙÙ‚Ø·</option>
                <option value="expense">Ù…ØµØ§Ø±ÙŠÙ ÙÙ‚Ø·</option>
              </select>
              <select id="filterCategory">
                <option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
              </select>
            </div>
            <div class="row">
              <input id="filterSearch" type="text" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." />
              <button class="btn" id="btnClearFilters">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <input id="filterFrom" type="date" placeholder="Ù…Ù†" />
            <input id="filterTo" type="date" placeholder="Ø¥Ù„Ù‰" />
            <input id="filterMin" type="number" inputmode="numeric" placeholder="Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº" />
            <input id="filterMax" type="number" inputmode="numeric" placeholder="Ø£Ø¹Ù„Ù‰ Ù…Ø¨Ù„Øº" />
          </div>

          <div class="hr"></div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th style="min-width:120px">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th style="min-width:110px">Ø§Ù„Ù†ÙˆØ¹</th>
                  <th style="min-width:140px">Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                  <th style="min-width:130px">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                  <th style="min-width:160px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="txTableBody">
                <tr><td colspan="6" class="muted">â€”</td></tr>
              </tbody>
            </table>
          </div>

          <div class="hr"></div>
          <div class="mini" id="txCount">â€”</div>
        </div>
      </div>
    </section>

    <!-- BUDGETS -->
    <section id="view-budgets" class="grid" style="display:none">
      <div class="card">
        <div class="hd">
          <div>
            <h2>ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù„Ù„Ø´Ù‡Ø±</h2>
            <p>Ø­Ø¯Ø¯ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…Ø®Ø·Ø·ØŒ Ø«Ù… ÙˆØ²Ù‘Ø¹Ù‡ Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª (Ø¥ÙŠØ¬Ø§Ø±ØŒ Ø¯ÙŠÙ†ØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ Ù…Ø§Ø¡ØŒ Ù…Ø´ØªØ±ÙŠØ§Øª...)</p>
          </div>
          <div class="row">
            <button class="btn small" id="btnAutoSuggestions">âœ¨ Ø§Ù‚ØªØ±Ø§Ø­ ØªÙˆØ²ÙŠØ¹ Ø³Ø±ÙŠØ¹</button>
            <button class="btn small" id="btnSaveBudgets">ğŸ’¾ Ø­ÙØ¸</button>
          </div>
        </div>
        <div class="bd">
          <div class="help">
            <div><b>ÙƒÙŠÙ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ØŸ</b> Ø¶Ø¹ â€œØ¯Ø®Ù„ Ù…Ø®Ø·Ø·â€ Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø±Ø§ØªØ¨ÙŠÙ†Ùƒ (Ù…Ø«Ù„Ø§Ù‹: 750,000 + 2,350,000) Ø«Ù… Ø¶Ø¹ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù„ÙƒÙ„ ØªØµÙ†ÙŠÙ. Ø³ØªØ´Ø§Ù‡Ø¯ â€œØºÙŠØ± Ù…ÙˆØ²Ù‘Ø¹â€ ÙˆØªØ¹Ø±Ù Ù‡Ù„ ØªØ®Ø·Ù‘ÙŠØª Ø§Ù„Ø¯Ø®Ù„.</div>
          </div>

          <div class="hr"></div>

          <div class="two">
            <div>
              <div style="font-weight:800;margin-bottom:6px">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…Ø®Ø·Ø· Ù„Ù„Ø´Ù‡Ø±</div>
              <div class="row">
                <input id="planIncome1" type="number" inputmode="numeric" placeholder="Ø±Ø§ØªØ¨ Ø«Ø§Ø¨Øª (Ù…Ø«Ø§Ù„ 750000)" />
                <input id="planIncome2" type="number" inputmode="numeric" placeholder="Ø±Ø§ØªØ¨ Ù…ØªØºÙŠØ± (Ù…Ø«Ø§Ù„ 2350000)" />
              </div>
              <div class="row" style="margin-top:10px">
                <input id="planNote" type="text" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ): Ù…Ø«Ø§Ù„ Ø±Ø§ØªØ¨ SEPCO3 + Ø¯Ø®Ù„ Ø¢Ø®Ø±" style="flex:1" />
              </div>

              <div class="hr"></div>
              <div class="kpi" style="border-radius:14px">
                <div>
                  <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…Ø®Ø·Ø·</div>
                  <div class="value" id="planIncomeTotal">â€”</div>
                  <div class="hint">Ù‡Ø°Ø§ Ù„Ù„ØªØ®Ø·ÙŠØ· ÙÙ‚Ø· (Ù„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©)</div>
                </div>
                <span class="tag">ğŸ—“ï¸</span>
              </div>
            </div>

            <div>
              <div style="font-weight:800;margin-bottom:6px">Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆØ²ÙŠØ¹</div>
              <div class="kpi" style="border-radius:14px;margin-bottom:10px">
                <div>
                  <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø®Ø·Ø·Ø©</div>
                  <div class="value" id="planBudgetTotal">â€”</div>
                  <div class="hint">Ù…Ø¬Ù…ÙˆØ¹ ÙƒÙ„ ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…ØµØ±ÙˆÙ</div>
                </div>
                <span class="tag">ğŸ§©</span>
              </div>
              <div class="kpi" style="border-radius:14px">
                <div>
                  <div class="label">Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± Ø§Ù„Ù…ÙˆØ²Ø¹</div>
                  <div class="value" id="planUnallocated">â€”</div>
                  <div class="hint">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…Ø®Ø·Ø· âˆ’ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø®Ø·Ø·Ø©</div>
                </div>
                <span class="tag">ğŸ¯</span>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:800;margin-bottom:4px">Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª (Ù…ØµØ±ÙˆÙ)</div>
              <div class="mini">Ø¹Ø¯Ù‘Ù„ Ø£ÙŠ Ù…Ø¨Ù„Øº â€” Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ø·ÙŠÙƒ Ù…Ù‚Ø§Ø±Ù†Ø© â€œÙ…Ø®Ø·Ø· vs ÙØ¹Ù„ÙŠâ€</div>
            </div>
            <button class="btn small" id="btnCategories2">ğŸ·ï¸ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ ØªØµÙ†ÙŠÙØ§Øª</button>
          </div>

          <div style="overflow:auto;margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th style="min-width:170px">Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                  <th style="min-width:150px">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®Ø·Ø·Ø©</th>
                  <th style="min-width:150px">Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ</th>
                  <th style="min-width:150px">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                  <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                </tr>
              </thead>
              <tbody id="budgetTableBody">
                <tr><td colspan="5" class="muted">â€”</td></tr>
              </tbody>
            </table>
          </div>

          <div class="hr"></div>
          <div class="mini">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª ØªÙØ­ÙØ¸ Ù„ÙƒÙ„ Ø´Ù‡Ø± Ø¹Ù„Ù‰ Ø­Ø¯Ø©.</div>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="view-reports" class="grid" style="display:none">
      <div class="card">
        <div class="hd">
          <div>
            <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„</h2>
            <p>Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø¢Ø®Ø± 12 Ø´Ù‡Ø± + ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª.</p>
          </div>
          <div class="row">
            <button class="btn small" id="btnRefreshReports">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
          </div>
        </div>
        <div class="bd">
          <div class="split">
            <div>
              <div style="font-weight:800;margin-bottom:4px">Ø§ØªØ¬Ø§Ù‡ Ø´Ù‡Ø±ÙŠ (Ø¢Ø®Ø± 12 Ø´Ù‡Ø±)</div>
              <div class="mini">Ø¥ÙŠØ±Ø§Ø¯/Ù…ØµØ±ÙˆÙ â€” Ù„Ù…Ø¹Ø±ÙØ© Ù†Ù…Ø· Ø§Ù„ØµØ±Ù Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†</div>
              <div style="margin-top:10px"><canvas id="trendChart"></canvas></div>
            </div>
            <div>
              <div style="font-weight:800;margin-bottom:4px">Ø£ÙØ¶Ù„ 5 ØªØµÙ†ÙŠÙØ§Øª ØµØ±ÙØ§Ù‹</div>
              <div class="mini">Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯</div>
              <div style="margin-top:10px;overflow:auto">
                <table>
                  <thead>
                    <tr>
                      <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                      <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                      <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                    </tr>
                  </thead>
                  <tbody id="topCatsBody">
                    <tr><td colspan="3" class="muted">â€”</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="help" style="margin-top:12px">
                <div><b>Ø­ÙŠÙ„Ø© Ø¨Ø³ÙŠØ·Ø©:</b> Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª ØªØµÙ†ÙŠÙ â€œÙ…Ø´ØªØ±ÙŠØ§Øªâ€ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ØŒ Ù‚Ø³Ù‘Ù…Ù‡ Ø¥Ù„Ù‰ (Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª/Ù…Ø·Ø§Ø¹Ù…/ÙƒÙ…Ø§Ù„ÙŠØ§Øª) Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</div>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <div style="font-weight:800;margin-bottom:4px">Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‚Ø§Ø±Ù†Ø©: ÙØ¹Ù„ÙŠ Ù…Ù‚Ø§Ø¨Ù„ Ù…Ø®Ø·Ø·</div>
              <div class="mini">ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± (Ø¥Ù† ÙˆÙØ¬Ø¯Øª) Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ÙØ¹Ù„ÙŠ</div>
            </div>
          </div>
          <div style="overflow:auto;margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th style="min-width:170px">Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                  <th style="min-width:150px">Ù…Ø®Ø·Ø·</th>
                  <th style="min-width:150px">ÙØ¹Ù„ÙŠ</th>
                  <th style="min-width:150px">ÙØ±Ù‚</th>
                  <th style="min-width:120px">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody id="planVsActualBody">
                <tr><td colspan="5" class="muted">â€”</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="view-settings" class="grid" style="display:none">
      <div class="card">
        <div class="hd">
          <div>
            <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª + Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
          </div>
        </div>
        <div class="bd">
          <div class="split">
            <div class="card" style="box-shadow:none">
              <div class="hd">
                <div>
                  <h2>Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h2>
                  <p>Ø£Ø¶Ù/Ø¹Ø¯Ù‘Ù„/Ø§Ø­Ø°Ù ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ø­Ø±ÙŠØ©.</p>
                </div>
                <div class="row">
                  <button class="btn small" id="btnCategories3">ğŸ·ï¸ Ø¥Ø¯Ø§Ø±Ø©</button>
                </div>
              </div>
              <div class="bd">
                <div class="mini">Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ ØªØµÙ†ÙŠÙØ§Øª Ù…Ø¹Ù‚ÙˆÙ„ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±. Ù…Ø«Ø§Ù„: (Ø¥ÙŠØ¬Ø§Ø±ØŒ Ø¯ÙŠÙ†ØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ Ù…Ø§Ø¡ØŒ Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØªØŒ Ù…Ø·Ø§Ø¹Ù…ØŒ Ù…ÙˆØ§ØµÙ„Ø§ØªØŒ ØµØ­Ø©ØŒ ØªØ±ÙÙŠÙ‡).</div>
              </div>
            </div>

            <div class="card" style="box-shadow:none">
              <div class="hd">
                <div>
                  <h2>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
                  <p>ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ (JSON) â€” Ù…Ù‡Ù… Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ.</p>
                </div>
              </div>
              <div class="bd">
                <div class="row">
                  <button class="btn" id="btnExport2">â¬‡ï¸ ØªØµØ¯ÙŠØ± JSON</button>
                  <button class="btn" id="btnImport2">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
                </div>
                <div class="hr"></div>
                <button class="btn danger" id="btnClearAll">ğŸ§¨ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <div class="mini" style="margin-top:10px">ØªØ­Ø°ÙŠØ±: Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØµØ¯ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³Ø­.</div>
              </div>
            </div>
          </div>

          <div class="hr"></div>
          <div class="mini">
            <div>ğŸ“Œ <b>Ù…Ø¹Ù„ÙˆÙ…Ø© ØªÙ‚Ù†ÙŠØ©:</b> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ®Ø²Ù‘ÙÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ (LocalStorage) Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·. Ø¥Ø°Ø§ ÙØªØ­Øª Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù…ØªØµÙØ­ Ø¢Ø®Ø± Ø£Ùˆ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø± Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù JSON.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- MODALS -->
    <div class="modal" id="modalTx">
      <div class="dialog">
        <div class="hd">
          <div>
            <h3 id="txTitle">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©</h3>
            <div class="mini">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠÙØ¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ù„Ø§ ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹).</div>
          </div>
          <button class="btn icon" data-close="#modalTx">âœ–</button>
        </div>
        <div class="bd">
          <div class="two">
            <div>
              <label class="mini">Ø§Ù„Ù†ÙˆØ¹</label>
              <select id="txType">
                <option value="expense">Ù…ØµØ±ÙˆÙ</option>
                <option value="income">Ø¥ÙŠØ±Ø§Ø¯</option>
              </select>
            </div>
            <div>
              <label class="mini">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input id="txDate" type="date" placeholder="YYYY-MM-DD" />
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label class="mini">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
              <select id="txCategory"></select>
            </div>
            <div>
              <label class="mini">Ø§Ù„Ù…Ø¨Ù„Øº (IQD)</label>
              <input id="txAmount" type="number" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 25000" />
            </div>
          </div>

          <div style="margin-top:10px">
            <label class="mini">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="txNote" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¥ÙŠØ¬Ø§Ø± / Ø³Ù„ÙØ© / Ù…Ø´ØªØ±ÙŠØ§Øª" />
          </div>

          <div class="help" style="margin-top:12px">
            <div><b>Ø§Ù‚ØªØ±Ø§Ø­:</b> Ø£Ù†Ø´Ø¦ ØªØµÙ†ÙŠÙØ§Øª Ø«Ø§Ø¨ØªØ©: (Ø¥ÙŠØ¬Ø§Ø±) Ùˆ(Ø¯ÙŠÙ†) Ùˆ(ÙƒÙ‡Ø±Ø¨Ø§Ø¡) Ùˆ(Ù…Ø§Ø¡) Ùˆ(Ù…Ø´ØªØ±ÙŠØ§Øª) Ø«Ù… Ù‚Ø³Ù‘Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¥Ø°Ø§ Ø§Ø­ØªØ¬Øª.</div>
          </div>
        </div>
        <div class="ft">
          <button class="btn primary" id="btnSaveTx">ğŸ’¾ Ø­ÙØ¸</button>
          <button class="btn" data-close="#modalTx">Ø¥Ù„ØºØ§Ø¡</button>
          <span class="mini muted" id="txEditingHint" style="margin-right:auto;display:none">ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</span>
        </div>
      </div>
    </div>

    <div class="modal" id="modalCategories">
      <div class="dialog">
        <div class="hd">
          <div>
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h3>
            <div class="mini">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙØ§Øª Ù„Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø£Ùˆ Ø§Ù„Ù…ØµØ±ÙˆÙ.</div>
          </div>
          <button class="btn icon" data-close="#modalCategories">âœ–</button>
        </div>
        <div class="bd">
          <div class="two">
            <div>
              <div style="font-weight:800;margin-bottom:6px">ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…ØµØ±ÙˆÙ</div>
              <div class="row">
                <input id="newExpenseCat" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ (Ù…Ø«Ø§Ù„: Ø¥ÙŠØ¬Ø§Ø±)" style="flex:1" />
                <button class="btn small" id="btnAddExpenseCat">â• Ø¥Ø¶Ø§ÙØ©</button>
              </div>
              <div id="expenseCatsList" style="margin-top:10px"></div>
            </div>
            <div>
              <div style="font-weight:800;margin-bottom:6px">ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</div>
              <div class="row">
                <input id="newIncomeCat" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ (Ù…Ø«Ø§Ù„: Ø±Ø§ØªØ¨ Ø«Ø§Ø¨Øª)" style="flex:1" />
                <button class="btn small" id="btnAddIncomeCat">â• Ø¥Ø¶Ø§ÙØ©</button>
              </div>
              <div id="incomeCatsList" style="margin-top:10px"></div>
            </div>
          </div>

          <div class="help" style="margin-top:12px">
            <div><b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ø¥Ø°Ø§ Ø­Ø°ÙØª ØªØµÙ†ÙŠÙØ§Ù‹ Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©ØŒ Ø³ÙŠØ¨Ù‚Ù‰ Ø¶Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙƒÙ€ â€œØºÙŠØ± Ù…ØµÙ†Ùâ€.</div>
          </div>
        </div>
        <div class="ft">
          <button class="btn" data-close="#modalCategories">ØªÙ…</button>
        </div>
      </div>
    </div>

    <div class="modal" id="modalImport">
      <div class="dialog">
        <div class="hd">
          <div>
            <h3>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <div class="mini">Ø§Ù„ØµÙ‚ Ù…Ø­ØªÙˆÙ‰ JSON Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ (Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©).</div>
          </div>
          <button class="btn icon" data-close="#modalImport">âœ–</button>
        </div>
        <div class="bd">
          <div class="row">
            <input type="file" id="importFile" accept="application/json" />
            <button class="btn" id="btnLoadFromFile">ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ù…Ù„Ù</button>
          </div>
          <div class="hr"></div>
          <textarea id="importText" placeholder="{ ... JSON ... }"></textarea>
        </div>
        <div class="ft">
          <button class="btn primary" id="btnDoImport">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
          <button class="btn" data-close="#modalImport">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>

    <div class="modal" id="modalExport">
      <div class="dialog">
        <div class="hd">
          <div>
            <h3>ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</h3>
            <div class="mini">Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø£Ùˆ Ø­Ù…Ù‘Ù„ Ø§Ù„Ù…Ù„Ù ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.</div>
          </div>
          <button class="btn icon" data-close="#modalExport">âœ–</button>
        </div>
        <div class="bd">
          <textarea id="exportText" readonly></textarea>
          <div class="hr"></div>
          <div class="row">
            <button class="btn" id="btnCopyExport">ğŸ“‹ Ù†Ø³Ø®</button>
            <button class="btn primary" id="btnDownloadExport">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù</button>
          </div>
        </div>
        <div class="ft">
          <button class="btn" data-close="#modalExport">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>

  </div>


  
    <div class="modal" id="modalCloud">
  <div class="dialog">
    <div class="hd">
      <div>
        <h3>â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© (Firebase)</h3>
        <p class="mini">Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©. ÙŠÙ…ÙƒÙ†ÙƒÙ… (Ø£Ù†Øª ÙˆØ²ÙˆØ¬ØªÙƒ) Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ø­Ø³Ø§Ø¨.</p>
      </div>
      <button class="btn icon" data-close="#modalCloud" aria-label="Close">âœ•</button>
    </div>
    <div class="bd">
      <div class="help" id="cloudHint">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¹Ù†Ø¯ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø³ÙŠØ¹Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ ÙˆØ³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„.</div>
      <div class="hr"></div>

      <div class="two" id="cloudCreds">
        <div>
          <label class="mini">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="cloudEmail" type="email" placeholder="example@email.com" autocomplete="email" />
        </div>
        <div>
          <label class="mini">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="cloudPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
        </div>
      </div>

      <div class="row end" style="margin-top:10px">
        <button class="btn primary" id="btnCloudLogin">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button class="btn danger" id="btnCloudLogout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between; gap:10px">
        <span class="pill" id="cloudConnPill">â˜ï¸ ØºÙŠØ± Ù…ØªØµÙ„</span>
        <span class="mini" id="cloudLast">Ø¢Ø®Ø± Ø­ÙØ¸: â€”</span>
      </div>

      <div class="mini" id="cloudStatus" style="margin-top:8px">Ø§Ù„Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù…ØªØµÙ„</div>

      <details style="margin-top:10px">
        <summary class="mini" style="cursor:pointer">Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</summary>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnCloudPull">â¬‡ï¸ Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
          <button class="btn" id="btnCloudPush">â¬†ï¸ Ø­ÙØ¸ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©</button>
          <button class="btn" id="btnCloudRestoreBackup">ğŸ§© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        </div>
        <div class="mini" style="margin-top:8px;color:var(--muted)">
          Ø¹Ø§Ø¯Ø©Ù‹ Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ø£Ù† Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ. Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§ ÙÙ‚Ø· Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ÙØ±Ø¶ Ø¬Ù„Ø¨/Ø­ÙØ¸ ÙŠØ¯ÙˆÙŠ.
        </div>
      </details>

    </div>
    <div class="ft">
      <button class="btn" data-close="#modalCloud">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

  <!-- Firebase (CDN) - for Cloud Sync -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

<script>
/** =========================
 *  Personal Finance Manager
 *  - Single file, offline
 *  - Storage: LocalStorage
 *  ========================= */
(function(){
  const STORAGE_KEY = "pfm_data_v1";
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const fmt = new Intl.NumberFormat("ar-IQ", { style:"currency", currency:"IQD", maximumFractionDigits: 0 });
  const fmtCompact = (n) => fmt.format(Math.round(n||0));

  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  const todayISO = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  };
  const thisMonth = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    return `${yyyy}-${mm}`;
  };
  const monthFromDate = (iso) => (iso||"").slice(0,7);

  const defaultData = () => ({
    version: 1,
    categories: [
      // Expense
      { id: "ex_rent", type:"expense", name:"Ø¥ÙŠØ¬Ø§Ø±" },
      { id: "ex_debt", type:"expense", name:"Ø¯ÙŠÙ†/Ø³Ø¯Ø§Ø¯" },
      { id: "ex_elec", type:"expense", name:"ÙƒÙ‡Ø±Ø¨Ø§Ø¡" },
      { id: "ex_water", type:"expense", name:"Ù…Ø§Ø¡" },
      { id: "ex_grocery", type:"expense", name:"Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª" },
      { id: "ex_food", type:"expense", name:"Ù…Ø·Ø§Ø¹Ù…" },
      { id: "ex_transport", type:"expense", name:"Ù…ÙˆØ§ØµÙ„Ø§Øª" },
      { id: "ex_family", type:"expense", name:"Ø¹Ø§Ø¦Ù„Ø©/Ù…Ù†Ø²Ù„" },
      { id: "ex_health", type:"expense", name:"ØµØ­Ø©" },
      { id: "ex_misc", type:"expense", name:"Ù…ØªÙØ±Ù‚Ø§Øª" },
      // Income
      { id: "in_fixed", type:"income", name:"Ø±Ø§ØªØ¨ Ø«Ø§Ø¨Øª" },
      { id: "in_var", type:"income", name:"Ø±Ø§ØªØ¨ Ù…ØªØºÙŠØ±" },
      { id: "in_other", type:"income", name:"Ø¯Ø®Ù„ Ø¢Ø®Ø±" },
    ],
    transactions: [],
    budgets: {
      // "YYYY-MM": { plan: {income1, income2, note}, items: {catId: {amount, note}} }
    }
  });

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultData();
      const parsed = JSON.parse(raw);
      // minimal migration safety
      if(!parsed.categories || !parsed.transactions || !parsed.budgets) return defaultData();
      return parsed;
    }catch(e){
      console.warn("Load error", e);
      return defaultData();
    }
  }
  function save(emit=true){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    if(emit){
      try{ window.dispatchEvent(new CustomEvent("pfm:changed", {detail: state})); }catch(e){}
    }
  }

  let state = load();
  let activeTab = "dash";
  let activeMonth = thisMonth();
  let editingTxId = null;

  // --- DOM refs
  const monthPicker = $("#monthPicker");
  monthPicker.value = activeMonth;

  // Tabs
  $$("#tabs .tab").forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));
  function setTab(tab){
    activeTab = tab;
    $$("#tabs .tab").forEach(t => t.classList.toggle("active", t.dataset.tab===tab));
    $$("#view-dash, #view-tx, #view-budgets, #view-reports, #view-settings").forEach(v => v.style.display="none");
    $(`#view-${tab}`).style.display = "block";
    render();
  }

  // Month change
  monthPicker.addEventListener("change", () => {
    activeMonth = monthPicker.value || thisMonth();
    render();
  });

  // Modal helpers
  function openModal(sel){ $(sel).classList.add("open"); }
  window.openModal = openModal;
  window.closeModal = closeModal;
  function closeModal(sel){ $(sel).classList.remove("open"); }
  $$("[data-close]").forEach(b => b.addEventListener("click", () => closeModal(b.getAttribute("data-close"))));
  document.addEventListener("keydown", (e) => {
    if(e.key==="Escape"){
      $$(".modal.open").forEach(m => m.classList.remove("open"));
    }
  });

  // --- Category helpers
  function categoriesByType(type){
    return state.categories.filter(c => c.type===type).sort((a,b)=> a.name.localeCompare(b.name, "ar"));
  }
  function catName(id){
    const c = state.categories.find(x=>x.id===id);
    return c ? c.name : "ØºÙŠØ± Ù…ØµÙ†Ù";
  }

  // --- Transactions helpers
  function txInMonth(month){
    return state.transactions.filter(t => monthFromDate(t.date)===month);
  }
  function sumAmount(arr){ return arr.reduce((s,x)=> s + (Number(x.amount)||0), 0); }
  function totalsForMonth(month){
    const txs = txInMonth(month);
    const income = sumAmount(txs.filter(t=>t.type==="income"));
    const expense = sumAmount(txs.filter(t=>t.type==="expense"));
    return { income, expense, net: income-expense, txs };
  }

  // --- Render functions
  function render(){
    // keep month picker in sync
    monthPicker.value = activeMonth;

    // Update filters category dropdown
    renderFilterCategories();

    // Render views
    if(activeTab==="dash") renderDashboard();
    if(activeTab==="tx") renderTransactions();
    if(activeTab==="budgets") renderBudgets();
    if(activeTab==="reports") renderReports();
    if(activeTab==="settings") renderSettings();
  }

  function renderDashboard(){
    const {income, expense, net} = totalsForMonth(activeMonth);
    $("#kpiIncome").textContent = fmtCompact(income);
    $("#kpiExpense").textContent = fmtCompact(expense);
    $("#kpiNet").textContent = fmtCompact(net);
    const rate = income>0 ? (net/income)*100 : 0;
    $("#kpiSavingRate").textContent = income>0 ? `${rate.toFixed(1)}%` : "â€”";

    const pill = $("#pillStatus");
    pill.className = "pill";
    if(net>=0 && expense<=income){ pill.classList.add("ok"); pill.textContent = "Ø¶Ù…Ù† Ø§Ù„Ø³ÙŠØ·Ø±Ø© âœ…"; }
    else if(net<0){ pill.classList.add("danger"); pill.textContent = "Ø¹Ø¬Ø² (Ù…ØµØ§Ø±ÙŠÙ Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ø¯Ø®Ù„) âš ï¸"; }
    else { pill.classList.add("warn"); pill.textContent = "Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ğŸ¤"; }

    drawPie("pieExpense", expenseBreakdown(activeMonth));
    drawBarIncomeExpense("barIncomeExpense", income, expense);

    renderOverspendList();
  }

  function renderOverspendList(){
    const plan = getBudgetForMonth(activeMonth);
    const actualByCat = expenseByCategory(activeMonth);
    const overs = [];
    for(const [catId, actual] of Object.entries(actualByCat)){
      const planned = Number(plan.items?.[catId]?.amount || 0);
      if(planned>0 && actual>planned){
        overs.push({catId, planned, actual});
      }
    }
    const box = $("#overspendList");
    if(overs.length===0){
      box.innerHTML = `<span class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§ÙˆØ²Ø§Øª (Ø£Ùˆ Ù„Ù… ØªÙ‚Ù… Ø¨ØªØ­Ø¯ÙŠØ¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø¨Ø¹Ø¯).</span>`;
      return;
    }
    overs.sort((a,b)=> (b.actual-b.planned)-(a.actual-a.planned));
    box.innerHTML = overs.map(o=>{
      const diff = o.actual - o.planned;
      return `<div class="row" style="justify-content:space-between;padding:10px;border:1px solid rgba(255,255,255,.06);border-radius:14px;background:rgba(7,12,28,.35);margin-bottom:8px">
        <div><b>${escapeHTML(catName(o.catId))}</b><div class="mini">Ù…Ø®Ø·Ø·: ${fmtCompact(o.planned)} â€” ÙØ¹Ù„ÙŠ: ${fmtCompact(o.actual)}</div></div>
        <span class="pill danger">+${fmtCompact(diff)}</span>
      </div>`;
    }).join("");
  }

  function renderFilterCategories(){
    const sel = $("#filterCategory");
    const prev = sel.value;
    sel.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>` + state.categories
      .slice().sort((a,b)=> a.name.localeCompare(b.name, "ar"))
      .map(c => `<option value="${c.id}">${escapeHTML(c.name)} (${c.type==="income"?"Ø¥ÙŠØ±Ø§Ø¯":"Ù…ØµØ±ÙˆÙ"})</option>`).join("");
    sel.value = prev;
  }

  function renderTransactions(){
    const tbody = $("#txTableBody");

    const typeFilter = $("#filterType").value;
    const catFilter = $("#filterCategory").value;
    const q = ($("#filterSearch").value || "").trim().toLowerCase();
    const from = $("#filterFrom").value;
    const to = $("#filterTo").value;
    const min = Number($("#filterMin").value||0);
    const maxRaw = $("#filterMax").value;
    const max = maxRaw === "" ? null : Number(maxRaw);

    let txs = state.transactions.slice()
      .filter(t => monthFromDate(t.date)===activeMonth)
      .sort((a,b)=> (b.date||"").localeCompare(a.date||""));

    if(typeFilter) txs = txs.filter(t => t.type===typeFilter);
    if(catFilter) txs = txs.filter(t => t.categoryId===catFilter);
    if(q) txs = txs.filter(t => (t.note||"").toLowerCase().includes(q));
    if(from) txs = txs.filter(t => (t.date||"")>=from);
    if(to) txs = txs.filter(t => (t.date||"")<=to);
    if(min) txs = txs.filter(t => Number(t.amount||0) >= min);
    if(max!==null) txs = txs.filter(t => Number(t.amount||0) <= max);

    if(txs.length===0){
      tbody.innerHTML = `<tr><td colspan="6" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„ÙÙ„Ø§ØªØ±.</td></tr>`;
      $("#txCount").textContent = "0 Ø¹Ù…Ù„ÙŠØ©";
      return;
    }

    tbody.innerHTML = txs.map(t=>{
      const signClass = t.type==="income" ? "pos" : "neg";
      const labelType = t.type==="income" ? `<span class="pill ok">Ø¥ÙŠØ±Ø§Ø¯</span>` : `<span class="pill danger">Ù…ØµØ±ÙˆÙ</span>`;
      return `<tr>
        <td>${escapeHTML(t.date||"")}</td>
        <td>${labelType}</td>
        <td><span class="tag">ğŸ·ï¸ ${escapeHTML(catName(t.categoryId))}</span></td>
        <td class="money ${signClass}">${fmtCompact(t.amount)}</td>
        <td>${escapeHTML(t.note||"")}</td>
        <td>
          <div class="actions">
            <button class="btn small" data-edit="${t.id}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn small danger" data-del="${t.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </td>
      </tr>`;
    }).join("");

    $("#txCount").textContent = `${txs.length} Ø¹Ù…Ù„ÙŠØ©`;
    // bind action buttons
    $$("[data-edit]", tbody).forEach(b => b.addEventListener("click", () => editTx(b.getAttribute("data-edit"))));
    $$("[data-del]", tbody).forEach(b => b.addEventListener("click", () => deleteTx(b.getAttribute("data-del"))));
  }

  function renderBudgets(){
    const plan = getBudgetForMonth(activeMonth);

    $("#planIncome1").value = plan.plan?.income1 ?? "";
    $("#planIncome2").value = plan.plan?.income2 ?? "";
    $("#planNote").value = plan.plan?.note ?? "";

    const planIncomeTotal = Number($("#planIncome1").value||0) + Number($("#planIncome2").value||0);
    $("#planIncomeTotal").textContent = fmtCompact(planIncomeTotal);

    const expenseCats = categoriesByType("expense");
    const actualByCat = expenseByCategory(activeMonth);

    const tbody = $("#budgetTableBody");
    if(expenseCats.length===0){
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙØ§Øª Ù…ØµØ±ÙˆÙ. Ø£Ø¶Ù ØªØµÙ†ÙŠÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹.</td></tr>`;
      return;
    }

    const rows = expenseCats.map(c=>{
      const planned = Number(plan.items?.[c.id]?.amount || 0);
      const note = plan.items?.[c.id]?.note || "";
      const actual = Number(actualByCat[c.id] || 0);
      const remaining = planned - actual;
      const remainingPill = planned>0
        ? (remaining>=0 ? `<span class="pill ok">${fmtCompact(remaining)}</span>` : `<span class="pill danger">${fmtCompact(remaining)}</span>`)
        : `<span class="pill">â€”</span>`;
      return `<tr data-cat="${c.id}">
        <td><b>${escapeHTML(c.name)}</b></td>
        <td>
          <input class="budgetInput" type="number" inputmode="numeric" placeholder="0" value="${planned||""}" />
        </td>
        <td>${fmtCompact(actual)}</td>
        <td>${remainingPill}</td>
        <td><input class="budgetNote" type="text" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ (Ù…Ø«Ø§Ù„: Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø³Ø¯Ø§Ø¯ 10 ÙƒÙ„ Ø´Ù‡Ø±)" value="${escapeAttr(note)}" /></td>
      </tr>`;
    });

    tbody.innerHTML = rows.join("");

    // live compute totals
    function recalc(){
      const planIncomeTotal = Number($("#planIncome1").value||0) + Number($("#planIncome2").value||0);
      $("#planIncomeTotal").textContent = fmtCompact(planIncomeTotal);

      let plannedTotal = 0;
      $$(".budgetInput", tbody).forEach(inp => plannedTotal += Number(inp.value||0));
      $("#planBudgetTotal").textContent = fmtCompact(plannedTotal);
      $("#planUnallocated").textContent = fmtCompact(planIncomeTotal - plannedTotal);
      const un = planIncomeTotal - plannedTotal;
      $("#planUnallocated").style.color = un>=0 ? "#bfffe0" : "#ffd0d0";
    }
    recalc();

    $$("#planIncome1, #planIncome2").forEach(inp => inp.addEventListener("input", recalc));
    $$(".budgetInput", tbody).forEach(inp => inp.addEventListener("input", recalc));

    // store temporary in DOM, save via button
    $("#btnSaveBudgets").onclick = () => {
      const planIncome1 = Number($("#planIncome1").value||0);
      const planIncome2 = Number($("#planIncome2").value||0);
      const planNote = ($("#planNote").value||"").trim();

      const items = {};
      $$("tr[data-cat]", tbody).forEach(tr=>{
        const catId = tr.getAttribute("data-cat");
        const amount = Number($(".budgetInput", tr).value||0);
        const note = ($(".budgetNote", tr).value||"").trim();
        if(amount>0 || note){
          items[catId] = { amount, note };
        }
      });

      state.budgets[activeMonth] = { plan: { income1: planIncome1||0, income2: planIncome2||0, note: planNote }, items };
      save();
      toast("ØªÙ… Ø­ÙØ¸ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© âœ…");
      render(); // refresh overspend & reports
    };

    $("#btnAutoSuggestions").onclick = () => {
      // Simple heuristic: allocate essential fixed categories first if exist, based on typical priorities.
      const incomeTotal = (Number($("#planIncome1").value||0) + Number($("#planIncome2").value||0)) || 0;
      if(incomeTotal<=0){
        toast("Ø¶Ø¹ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…Ø®Ø·Ø· Ø£ÙˆÙ„Ø§Ù‹ âœï¸");
        return;
      }
      // Defaults: Rent 30-35%, Debt 10-15%, Utilities 5-8%, Grocery 10-15%, Transport 5-8%, Rest split.
      const picks = [
        { ids:["ex_rent"], pct: 0.33 },
        { ids:["ex_debt"], pct: 0.12 },
        { ids:["ex_elec","ex_water"], pct: 0.06 },
        { ids:["ex_grocery"], pct: 0.13 },
        { ids:["ex_transport"], pct: 0.06 },
        { ids:["ex_health"], pct: 0.04 },
      ];
      const tbody = $("#budgetTableBody");
      const rows = $$("tr[data-cat]", tbody);
      const setBudget = (catId, value) => {
        const tr = rows.find(r => r.getAttribute("data-cat")===catId);
        if(tr){
          $(".budgetInput", tr).value = Math.round(value);
        }
      };
      // clear all first
      rows.forEach(tr => $(".budgetInput", tr).value = "");
      let used = 0;
      picks.forEach(p=>{
        const per = incomeTotal * p.pct;
        const each = per / p.ids.length;
        p.ids.forEach(id => { setBudget(id, each); used += each; });
      });
      // remainder to misc
      const remainder = incomeTotal - used;
      setBudget("ex_misc", Math.max(0, remainder));
      // recalc totals
      $$(".budgetInput", tbody).forEach(inp => inp.dispatchEvent(new Event("input")));
      toast("ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù‚ØªØ±Ø§Ø­ ØªÙˆØ²ÙŠØ¹ Ø³Ø±ÙŠØ¹ âœ¨ (Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø­Ø³Ø¨ ÙˆØ¶Ø¹Ùƒ)");
    };

  }

  function renderReports(){
    // trend 12 months
    const months = lastNMonths(activeMonth, 12);
    const series = months.map(m=>{
      const t = totalsForMonth(m);
      return { month:m, income:t.income, expense:t.expense, net:t.net };
    });
    drawTrend("trendChart", series);

    // top categories
    const breakdown = expenseBreakdown(activeMonth);
    const totalExp = breakdown.reduce((s,x)=>s+x.value,0);
    const top = breakdown.slice(0,5);

    const tbody = $("#topCatsBody");
    if(totalExp<=0){
      tbody.innerHTML = `<tr><td colspan="3" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</td></tr>`;
    }else{
      tbody.innerHTML = top.map(x=>{
        const pct = totalExp>0 ? (x.value/totalExp)*100 : 0;
        return `<tr>
          <td><b>${escapeHTML(x.label)}</b></td>
          <td>${fmtCompact(x.value)}</td>
          <td>${pct.toFixed(1)}%</td>
        </tr>`;
      }).join("");
    }

    // plan vs actual table
    const plan = getBudgetForMonth(activeMonth);
    const expenseCats = categoriesByType("expense");
    const actualByCat = expenseByCategory(activeMonth);
    const pv = $("#planVsActualBody");

    if(expenseCats.length===0){
      pv.innerHTML = `<tr><td colspan="5" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙØ§Øª Ù…ØµØ±ÙˆÙ.</td></tr>`;
      return;
    }

    pv.innerHTML = expenseCats.map(c=>{
      const planned = Number(plan.items?.[c.id]?.amount || 0);
      const actual = Number(actualByCat[c.id] || 0);
      const diff = planned - actual; // positive = under budget
      let status = `<span class="pill">Ø¨Ø¯ÙˆÙ† Ù…ÙŠØ²Ø§Ù†ÙŠØ©</span>`;
      if(planned>0){
        status = diff>=0 ? `<span class="pill ok">Ø¶Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</span>` : `<span class="pill danger">ØªØ¬Ø§ÙˆØ²</span>`;
      }
      return `<tr>
        <td><b>${escapeHTML(c.name)}</b></td>
        <td>${planned>0 ? fmtCompact(planned) : "â€”"}</td>
        <td>${fmtCompact(actual)}</td>
        <td>${planned>0 ? fmtCompact(diff) : "â€”"}</td>
        <td>${status}</td>
      </tr>`;
    }).join("");
  }

  function renderSettings(){
    // nothing heavy here; categories modal used
  }

  // --- Budget data access
  function getBudgetForMonth(month){
    return state.budgets[month] || { plan:{income1:0,income2:0,note:""}, items:{} };
  }

  // --- Breakdown helpers
  function expenseByCategory(month){
    const txs = txInMonth(month).filter(t=>t.type==="expense");
    const map = {};
    txs.forEach(t=>{
      const k = t.categoryId || "uncat";
      map[k] = (map[k]||0) + Number(t.amount||0);
    });
    return map;
  }

  function expenseBreakdown(month){
    const by = expenseByCategory(month);
    const items = Object.entries(by).map(([catId, value]) => ({
      label: catName(catId),
      value: Number(value||0)
    })).filter(x=>x.value>0);

    items.sort((a,b)=>b.value-a.value);
    return items;
  }

  // --- Charts (Canvas)
  function clearCanvas(ctx, w, h){
    ctx.clearRect(0,0,w,h);
  }

  function drawPie(canvasId, items){
    const canvas = $("#"+canvasId);
    const ctx = canvas.getContext("2d");
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.round(rect.width*dpr);
    canvas.height = Math.round(260*dpr);
    const w = canvas.width, h = canvas.height;
    clearCanvas(ctx,w,h);

    // If empty
    const total = items.reduce((s,x)=>s+x.value,0);
    if(total<=0){
      ctx.fillStyle = "rgba(255,255,255,.65)";
      ctx.font = `${14*dpr}px ${getFontFallback()}`;
      ctx.textAlign = "center";
      ctx.fillText("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù„Ø¹Ø±Ø¶Ù‡Ø§", w/2, h/2);
      return;
    }

    const cx = w/2, cy = h/2, r = Math.min(w,h)*0.32;
    let a0 = -Math.PI/2;

    // deterministic pseudo-colors based on label hash (without specifying a fixed palette)
    items.forEach((it)=>{
      const ang = (it.value/total)*Math.PI*2;
      const a1 = a0 + ang;

      const col = hashColor(it.label);
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,a0,a1);
      ctx.closePath();
      ctx.fillStyle = col;
      ctx.globalAlpha = 0.9;
      ctx.fill();
      ctx.globalAlpha = 1;

      a0 = a1;
    });

    // Legend
    ctx.font = `${12*dpr}px ${getFontFallback()}`;
    ctx.textAlign = "right";
    ctx.fillStyle = "rgba(255,255,255,.75)";
    const lx = w - 16*dpr;
    let ly = 18*dpr;
    items.slice(0,6).forEach(it=>{
      ctx.fillText(`${it.label} â€” ${fmtCompact(it.value)}`, lx, ly);
      ly += 18*dpr;
    });
    if(items.length>6){
      ctx.fillText(`+${items.length-6} ØªØµÙ†ÙŠÙØ§Øª Ø£Ø®Ø±Ù‰`, lx, ly);
    }
  }

  function drawBarIncomeExpense(canvasId, income, expense){
    const canvas = $("#"+canvasId);
    const ctx = canvas.getContext("2d");
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.round(rect.width*dpr);
    canvas.height = Math.round(260*dpr);
    const w = canvas.width, h = canvas.height;
    clearCanvas(ctx,w,h);

    const max = Math.max(income, expense, 1);
    const pad = 20*dpr;
    const baseY = h - pad;
    const barW = (w - pad*2) / 5;
    const gap = barW;

    // axes line
    ctx.strokeStyle = "rgba(255,255,255,.18)";
    ctx.lineWidth = 1*dpr;
    ctx.beginPath();
    ctx.moveTo(pad, baseY);
    ctx.lineTo(w-pad, baseY);
    ctx.stroke();

    const values = [
      { label:"Ø¥ÙŠØ±Ø§Ø¯", value: income, col: "rgba(124,255,232,.85)" },
      { label:"Ù…ØµØ±ÙˆÙ", value: expense, col: "rgba(255,107,107,.85)" },
    ];

    ctx.font = `${12*dpr}px ${getFontFallback()}`;
    ctx.textAlign = "center";
    values.forEach((v, i)=>{
      const x = pad + gap + i*(barW+gap);
      const bh = (v.value/max) * (h - pad*2);
      ctx.fillStyle = v.col;
      ctx.fillRect(x, baseY - bh, barW, bh);
      ctx.fillStyle = "rgba(255,255,255,.78)";
      ctx.fillText(v.label, x+barW/2, baseY + 16*dpr);
      ctx.fillText(shortMoney(v.value), x+barW/2, baseY - bh - 10*dpr);
    });
  }

  function drawTrend(canvasId, series){
    const canvas = $("#"+canvasId);
    const ctx = canvas.getContext("2d");
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.round(rect.width*dpr);
    canvas.height = Math.round(260*dpr);
    const w = canvas.width, h = canvas.height;
    clearCanvas(ctx,w,h);

    const pad = 22*dpr;
    const innerW = w - pad*2;
    const innerH = h - pad*2;

    // find max
    const maxV = Math.max(...series.flatMap(s=>[s.income,s.expense]), 1);

    // grid lines
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1*dpr;
    for(let i=0;i<=4;i++){
      const y = pad + (innerH*(i/4));
      ctx.beginPath();
      ctx.moveTo(pad, y);
      ctx.lineTo(w-pad, y);
      ctx.stroke();
    }

    // bars grouped
    const n = series.length;
    const groupW = innerW / n;
    const barW = Math.max(6*dpr, groupW * 0.28);
    const gap = barW * 0.25;

    series.forEach((s, idx)=>{
      const gx = pad + idx*groupW + groupW/2;

      const incomeH = (s.income/maxV)*innerH;
      const expH = (s.expense/maxV)*innerH;

      // income bar
      ctx.fillStyle = "rgba(124,255,232,.80)";
      ctx.fillRect(gx - barW - gap/2, pad + innerH - incomeH, barW, incomeH);

      // expense bar
      ctx.fillStyle = "rgba(255,107,107,.80)";
      ctx.fillRect(gx + gap/2, pad + innerH - expH, barW, expH);

      // month label every 2 steps
      if(idx%2===0){
        ctx.fillStyle = "rgba(255,255,255,.70)";
        ctx.font = `${10*dpr}px ${getFontFallback()}`;
        ctx.textAlign = "center";
        ctx.fillText(s.month.slice(2), gx, h - 6*dpr);
      }
    });

    // legend
    ctx.fillStyle = "rgba(255,255,255,.78)";
    ctx.font = `${12*dpr}px ${getFontFallback()}`;
    ctx.textAlign = "right";
    ctx.fillText("Ø¥ÙŠØ±Ø§Ø¯", w - pad, pad);
    ctx.fillStyle = "rgba(124,255,232,.80)";
    ctx.fillRect(w - pad - 70*dpr, pad - 10*dpr, 10*dpr, 10*dpr);

    ctx.fillStyle = "rgba(255,255,255,.78)";
    ctx.fillText("Ù…ØµØ±ÙˆÙ", w - pad, pad + 18*dpr);
    ctx.fillStyle = "rgba(255,107,107,.80)";
    ctx.fillRect(w - pad - 70*dpr, pad + 8*dpr, 10*dpr, 10*dpr);
  }

  function shortMoney(v){
    const n = Number(v||0);
    if(n >= 1_000_000) return (n/1_000_000).toFixed(2) + " Ù…";
    if(n >= 1_000) return (n/1_000).toFixed(0) + " Ùƒ";
    return String(Math.round(n));
  }

  function getFontFallback(){ return "Tahoma, Arial, sans-serif"; }

  // deterministic color from label (so the same category keeps a stable color)
  function hashColor(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    // map to HSL
    const hue = Math.abs(h) % 360;
    const sat = 70;
    const light = 55;
    return `hsl(${hue} ${sat}% ${light}%)`;
  }

  // --- Actions
  $("#btnAddTx").addEventListener("click", () => openTxModal());
  $("#btnAddTx2").addEventListener("click", () => openTxModal());
  $("#btnGoBudgets").addEventListener("click", () => { setTab("budgets"); });

  $("#btnCategories").addEventListener("click", () => openCategoriesModal());
  $("#btnCategories2").addEventListener("click", () => openCategoriesModal());
  $("#btnCategories3").addEventListener("click", () => openCategoriesModal());

  // Filters events
  ["filterType","filterCategory","filterSearch","filterFrom","filterTo","filterMin","filterMax"].forEach(id=>{
    $("#"+id).addEventListener("input", () => renderTransactions());
    $("#"+id).addEventListener("change", () => renderTransactions());
  });
  $("#btnClearFilters").addEventListener("click", () => {
    $("#filterType").value = "";
    $("#filterCategory").value = "";
    $("#filterSearch").value = "";
    $("#filterFrom").value = "";
    $("#filterTo").value = "";
    $("#filterMin").value = "";
    $("#filterMax").value = "";
    renderTransactions();
  });

  // Export / Import
  $("#btnExport").addEventListener("click", () => openExportModal());
  $("#btnExport2").addEventListener("click", () => openExportModal());
  $("#btnImport").addEventListener("click", () => openImportModal());
  $("#btnImport2").addEventListener("click", () => openImportModal());

  function openExportModal(){
    $("#exportText").value = JSON.stringify(state, null, 2);
    openModal("#modalExport");
  }
  $("#btnCopyExport").addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText($("#exportText").value);
      toast("ØªÙ… Ø§Ù„Ù†Ø³Ø® ğŸ“‹");
    }catch{
      toast("ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø® â€” Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹");
    }
  });
  $("#btnDownloadExport").addEventListener("click", () => {
    const blob = new Blob([$("#exportText").value], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `pfm-backup-${activeMonth}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  function openImportModal(){
    $("#importText").value = "";
    $("#importFile").value = "";
    openModal("#modalImport");
  }

  $("#btnLoadFromFile").addEventListener("click", async () => {
    const file = $("#importFile").files?.[0];
    if(!file){ toast("Ø§Ø®ØªØ± Ù…Ù„Ù JSON Ø£ÙˆÙ„Ø§Ù‹"); return; }
    const text = await file.text();
    $("#importText").value = text;
    toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ù„Ù");
  });

  $("#btnDoImport").addEventListener("click", () => {
    const txt = ($("#importText").value||"").trim();
    if(!txt){ toast("Ø§Ù„ØµÙ‚ JSON Ø£Ùˆ Ø­Ù…Ù‘Ù„ Ù…Ù† Ù…Ù„Ù"); return; }
    try{
      const parsed = JSON.parse(txt);
      if(!parsed.categories || !parsed.transactions || !parsed.budgets){
        toast("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
        return;
      }
      state = parsed;
      save();
      closeModal("#modalImport");
      toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…");
      render();
    }catch(e){
      toast("JSON ØºÙŠØ± ØµØ§Ù„Ø­");
    }
  });

  $("#btnClearAll").addEventListener("click", () => {
    const ok = confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ");
    if(!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    state = defaultData();
    save();
    toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    render();
  });

  // Reports refresh
  $("#btnRefreshReports").addEventListener("click", () => renderReports());

  // --- Transaction modal logic
  function openTxModal(tx=null){
    editingTxId = tx?.id || null;
    $("#txTitle").textContent = editingTxId ? "ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ©" : "Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©";
    $("#txEditingHint").style.display = editingTxId ? "inline" : "none";

    // populate categories based on selected type
    const type = tx?.type || "expense";
    $("#txType").value = type;
    fillTxCategories(type, tx?.categoryId);

    // manual date: do NOT auto-fill if new
    $("#txDate").value = tx?.date || "";
    $("#txAmount").value = tx?.amount ?? "";
    $("#txNote").value = tx?.note ?? "";

    openModal("#modalTx");
  }
  function fillTxCategories(type, selectedId=null){
    const cats = categoriesByType(type);
    const sel = $("#txCategory");
    if(cats.length===0){
      sel.innerHTML = `<option value="">(Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙØ§Øª)</option>`;
      return;
    }
    sel.innerHTML = cats.map(c => `<option value="${c.id}">${escapeHTML(c.name)}</option>`).join("");
    sel.value = selectedId && cats.some(c=>c.id===selectedId) ? selectedId : cats[0].id;
  }
  $("#txType").addEventListener("change", () => fillTxCategories($("#txType").value, null));

  $("#btnSaveTx").addEventListener("click", () => {
    const type = $("#txType").value;
    const date = $("#txDate").value;
    const categoryId = $("#txCategory").value;
    const amount = Number($("#txAmount").value||0);
    const note = ($("#txNote").value||"").trim();

    if(!date){ toast("Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠØ¯ÙˆÙŠØ§Ù‹)"); return; }
    if(!amount || amount<=0){ toast("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹"); return; }
    if(!type){ toast("Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹"); return; }

    if(editingTxId){
      const idx = state.transactions.findIndex(t=>t.id===editingTxId);
      if(idx>=0){
        state.transactions[idx] = { ...state.transactions[idx], type, date, categoryId, amount, note };
      }
    }else{
      state.transactions.push({ id: uid(), type, date, categoryId, amount, note, createdAt: new Date().toISOString() });
    }

    save();
    closeModal("#modalTx");
    toast(editingTxId ? "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…" : "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…");
    render();
  });

  function editTx(id){
    const tx = state.transactions.find(t=>t.id===id);
    if(!tx) return;
    openTxModal(tx);
  }
  function deleteTx(id){
    const ok = confirm("Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ");
    if(!ok) return;
    state.transactions = state.transactions.filter(t=>t.id!==id);
    save();
    toast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
    render();
  }

  // --- Categories modal logic
  function openCategoriesModal(){
    renderCategoriesLists();
    openModal("#modalCategories");
  }
  function renderCategoriesLists(){
    const exp = categoriesByType("expense");
    const inc = categoriesByType("income");

    $("#expenseCatsList").innerHTML = exp.map(c => catRow(c)).join("") || `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙØ§Øª.</div>`;
    $("#incomeCatsList").innerHTML = inc.map(c => catRow(c)).join("") || `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙØ§Øª.</div>`;

    // bind actions
    $$("[data-rename-cat]").forEach(b => b.addEventListener("click", () => renameCat(b.getAttribute("data-rename-cat"))));
    $$("[data-del-cat]").forEach(b => b.addEventListener("click", () => delCat(b.getAttribute("data-del-cat"))));
  }
  function catRow(c){
    return `<div class="row" style="justify-content:space-between;padding:10px;border:1px solid rgba(255,255,255,.06);border-radius:14px;background:rgba(7,12,28,.35);margin-bottom:8px">
      <div class="row"><span class="tag">ğŸ·ï¸</span><b>${escapeHTML(c.name)}</b></div>
      <div class="actions">
        <button class="btn small" data-rename-cat="${c.id}">âœï¸</button>
        <button class="btn small danger" data-del-cat="${c.id}">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }

  $("#btnAddExpenseCat").addEventListener("click", () => addCat("expense"));
  $("#btnAddIncomeCat").addEventListener("click", () => addCat("income"));

  function addCat(type){
    const inp = type==="expense" ? $("#newExpenseCat") : $("#newIncomeCat");
    const name = (inp.value||"").trim();
    if(!name){ toast("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ"); return; }
    // avoid duplicates
    const exists = state.categories.some(c=> c.type===type && normalize(c.name)===normalize(name));
    if(exists){ toast("Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹"); return; }
    state.categories.push({ id: `${type}_${uid()}`, type, name });
    inp.value = "";
    save();
    toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…");
    renderCategoriesLists();
    render();
  }

  function renameCat(id){
    const cat = state.categories.find(c=>c.id===id);
    if(!cat) return;
    const name = prompt("Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØµÙ†ÙŠÙ:", cat.name);
    if(name===null) return;
    const nn = name.trim();
    if(!nn){ toast("Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­"); return; }
    // avoid duplicates
    const exists = state.categories.some(c=> c.id!==id && c.type===cat.type && normalize(c.name)===normalize(nn));
    if(exists){ toast("Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹"); return; }
    cat.name = nn;
    save();
    toast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…");
    renderCategoriesLists();
    render();
  }

  function delCat(id){
    const cat = state.categories.find(c=>c.id===id);
    if(!cat) return;
    const ok = confirm(`Ø­Ø°Ù ØªØµÙ†ÙŠÙ "${cat.name}"ØŸ`);
    if(!ok) return;

    // remove from categories
    state.categories = state.categories.filter(c=>c.id!==id);

    // orphan used tx -> keep their categoryId; catName() will show "ØºÙŠØ± Ù…ØµÙ†Ù"
    // remove budgets for this category across months
    for(const m of Object.keys(state.budgets)){
      if(state.budgets[m]?.items?.[id]){
        delete state.budgets[m].items[id];
      }
    }

    save();
    toast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
    renderCategoriesLists();
    render();
  }

  // --- Utilities
  function normalize(s){
    return (s||"").toLowerCase().replace(/\s+/g," ").trim();
  }
  function escapeHTML(str){
    return String(str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str){
    return escapeHTML(str).replaceAll("\n"," ");
  }

  function lastNMonths(fromMonth, n){
    const [y, m] = fromMonth.split("-").map(Number);
    const out = [];
    let yy = y, mm = m;
    for(let i=0;i<n;i++){
      const mmStr = String(mm).padStart(2,"0");
      out.unshift(`${yy}-${mmStr}`);
      mm -= 1;
      if(mm===0){ mm=12; yy -= 1; }
    }
    return out;
  }

  // simple toast
  let toastTimer = null;
  function toast(msg){
    let el = $("#toast");
    if(!el){
      el = document.createElement("div");
      el.id = "toast";
      el.style.position = "fixed";
      el.style.left = "14px";
      el.style.bottom = "14px";
      el.style.zIndex = "50";
      el.style.maxWidth = "min(520px, 92vw)";
      el.style.padding = "12px 14px";
      el.style.border = "1px solid rgba(16,24,40,.14)";
      el.style.borderRadius = "14px";
      el.style.background = "rgba(255,255,255,.96)";
      el.style.boxShadow = "0 12px 30px rgba(16,24,40,.12)";
      el.style.color = "rgba(16,24,40,.92)";
      el.style.fontFamily = "var(--font)";
      el.style.backdropFilter = "blur(10px)";
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.opacity = "1";
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ el.style.opacity="0"; }, 2200);
  }

  // initial seed: helpful example for user
  function maybeSeed(){
    if(state.transactions.length>0) return;

    // Add a gentle example to show how to use (can be deleted).
    state.transactions.push(
      { id: uid(), type:"income", date: `${activeMonth}-01`, categoryId:"in_fixed", amount: 750000, note:"Ù…Ø«Ø§Ù„: Ø±Ø§ØªØ¨ Ø«Ø§Ø¨Øª", createdAt: new Date().toISOString() },
      { id: uid(), type:"expense", date: `${activeMonth}-02`, categoryId:"ex_grocery", amount: 25000, note:"Ù…Ø«Ø§Ù„: Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª", createdAt: new Date().toISOString() }
    );
    save();
  }
  maybeSeed();

  // Buttons in dashboard & settings that navigate
  $("#btnGoBudgets").addEventListener("click", () => setTab("budgets"));

  // Cloud -> apply incoming state without re-emitting
window.addEventListener("pfm:apply", (ev)=>{
  try{
    if(!ev || !ev.detail) return;
    state = ev.detail;
    save(false);
    render();
  }catch(err){
    console.error("Failed to apply cloud state:", err);
  }
});

  // Start
  render();

})();
</script>

<script>
/** =========================
 * Cloud Sync (Firebase Firestore) - Auto Sync PRO+
 * - Paste your firebaseConfig below.
 * - Stores data per-user at: pfm_users/{uid}
 * - Autosaves on every local change (debounced)
 * - Shows clear connection/saved status + basic conflict protection (backup + warning)
 * ========================= */
(function(){
  // 1) Paste from Firebase Console -> Project settings -> Your apps -> Web app config
  const firebaseConfig = {
  apiKey: "AIzaSyA2Aj8TJGVMeHS00SyI8pW04HWHTEOVU3o",
  authDomain: "budget-504fa.firebaseapp.com",
  projectId: "budget-504fa",
  storageBucket: "budget-504fa.firebasestorage.app",
  messagingSenderId: "444444163374",
  appId: "1:444444163374:web:80573893c3e75f415d4ebf",
};

  const STORAGE_KEY = "pfm_data_v1"; // must match main app
  const CLIENT_ID_KEY = "pfm_client_id_v1";
  const BACKUP_KEY = "pfm_backup_before_remote_v1";

  const $ = (sel, root=document) => root.querySelector(sel);

  const btnOpen   = $("#btnCloud");
  const modal     = $("#modalCloud");
  const emailEl   = $("#cloudEmail");
  const passEl    = $("#cloudPass");
  const btnLogin  = $("#btnCloudLogin");
  const btnLogout = $("#btnCloudLogout");
  const btnPull   = $("#btnCloudPull");
  const btnPush   = $("#btnCloudPush");
  const statusEl  = $("#cloudStatus");
  const pillEl    = $("#cloudConnPill");
  const badgeEl   = $("#cloudBadge");
  const lastEl    = $("#cloudLast");
  const hintEl    = $("#cloudHint");

  function setText(el, text){ if(el) el.textContent = text; }
  function setKind(el, kind){
    if(!el) return;
    el.classList.remove("ok","warn","danger");
    if(kind) el.classList.add(kind);
  }
  function setPill(text, kind){
    if(pillEl){ pillEl.textContent = text; setKind(pillEl, kind); }
    if(badgeEl){ badgeEl.textContent = text; setKind(badgeEl, kind); }
  }
  function setStatus(text){ setText(statusEl, text); }
  function setLast(tsText){ setText(lastEl, `Ø¢Ø®Ø± Ø­ÙØ¸: ${tsText || "â€”"}`); }

  function nowClock(){
    const d = new Date();
    return d.toLocaleString("ar-IQ", {hour12:true});
  }

  // Create a stable clientId (to ignore our own realtime echoes)
  function uuid4(){
    return (crypto?.randomUUID?.() || (Date.now().toString(16) + Math.random().toString(16).slice(2)));
  }
  let clientId = localStorage.getItem(CLIENT_ID_KEY);
  if(!clientId){
    clientId = uuid4();
    localStorage.setItem(CLIENT_ID_KEY, clientId);
  }

  // Open modal
  btnOpen?.addEventListener("click", ()=> modal?.classList.add("open"));

  // Configuration check
  const configured = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId;
  if(!configured){
    btnOpen?.addEventListener("click", ()=>{
      setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø¯Ø§Ø®Ù„ Ù…Ù„Ù index.html (firebaseConfig).");
      setPill("â˜ï¸ ØºÙŠØ± Ù…Ù‡ÙŠØ£", "warn");
    });
    setPill("â˜ï¸ ØºÙŠØ± Ù…Ù‡ÙŠØ£", "warn");
    return;
  }

  // Init Firebase (compat)
  try{
    if(!firebase.apps || !firebase.apps.length){
      firebase.initializeApp(firebaseConfig);
    }
  }catch(e){
    console.error(e);
  }
  const auth = firebase.auth();
  // Keep login across refreshes
  try{ auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
  const db   = firebase.firestore();
  const FieldValue = firebase.firestore.FieldValue;

  let unsubSnap = null;
  let pushTimer = null;
  let dirty = false;
  let lastLocalStr = null;
  let lastAppliedRemoteHash = null;
  let lastSavedPulseTimer = null;
  let lastSeenRemoteClientId = null;

  function localString(){
    try{ return localStorage.getItem(STORAGE_KEY) || ""; }catch(e){ return ""; }
  }
  function readLocal(){
    try{
      const s = localStorage.getItem(STORAGE_KEY);
      return s ? JSON.parse(s) : null;
    }catch(e){ return null; }
  }
  function hashStr(s){
    let h = 0; for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i))|0; }
    return String(h);
  }

  function pulseSaved(){
    clearTimeout(lastSavedPulseTimer);
    setPill("â˜ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ“", "ok");
    lastSavedPulseTimer = setTimeout(()=> {
      if(auth.currentUser) setPill("â˜ï¸ Ù…ØªØµÙ„", "ok");
    }, 1400);
  }

  async function ensureDoc(docRef){
    const snap = await docRef.get();
    if(!snap.exists){
      const data = readLocal();
      await docRef.set({
        data: data || {},
        createdAt: FieldValue.serverTimestamp(),
        updatedAt: FieldValue.serverTimestamp(),
        updatedBy: auth.currentUser.uid,
        updatedByClientId: clientId,
        version: 1
      }, {merge:true});
    }
  }

  async function pushToCloud(reason){
    if(!auth.currentUser){ setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù…ØªØµÙ„ (Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„)"); return; }
    const uid = auth.currentUser.uid;
    const docRef = db.collection("pfm_users").doc(uid);

    const data = readLocal();
    if(!data){ setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø­ÙØ¸"); return; }

    try{
      setStatus(`Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹... (${reason||"ØªØºÙŠÙŠØ±"})`);
      await docRef.set({
        data,
        updatedAt: FieldValue.serverTimestamp(),
        updatedBy: uid,
        updatedByClientId: clientId,
        version: 1
      }, {merge:true});
      dirty = false;
      setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…");
      setPill("â˜ï¸ Ù…ØªØµÙ„", "ok");
      pulseSaved();
      setLast(nowClock());
    }catch(err){
      console.error(err);
      const code = err && err.code ? ` (${err.code})` : "";
      setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ âŒ" + code + " â€” ØªØ­Ù‚Ù‚ Ù…Ù† Rules/Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
      setPill("â˜ï¸ Ø®Ø·Ø£", "danger");
      if(hintEl){
        hintEl.textContent = "ØªÙ†Ø¨ÙŠÙ‡: ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØºØ§Ù„Ø¨Ø§Ù‹ Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ùˆ Firestore Rules Ø£Ùˆ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† ØºÙŠØ± Ù…Ø¶Ø§Ù ÙÙŠ Authorized domains Ø£Ùˆ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
      }
    }
  }

  function schedulePush(reason){
    clearTimeout(pushTimer);
    pushTimer = setTimeout(()=> pushToCloud(reason), 800);
  }

  function backupLocalBeforeRemote(){
    try{
      const payload = {
        at: new Date().toISOString(),
        data: readLocal()
      };
      localStorage.setItem(BACKUP_KEY, JSON.stringify(payload));
    }catch(e){}
  }

  function startRealtime(docRef){
    if(unsubSnap) { try{ unsubSnap(); }catch(e){} }
    unsubSnap = docRef.onSnapshot((snap)=>{
      if(!snap.exists) return;

      const remote = snap.data() || {};
      const remoteData = remote.data || {};
      const remoteClientId = remote.updatedByClientId || null;
      lastSeenRemoteClientId = remoteClientId;

      // Ignore our own writes (prevents ping-pong and flicker)
      if(remoteClientId && remoteClientId === clientId){
        return;
      }

      const remoteStr = JSON.stringify(remoteData);
      const remoteHash = hashStr(remoteStr);

      const curLocalStr = localString();
      let localObj = {};
      try{ localObj = curLocalStr ? JSON.parse(curLocalStr) : {}; }catch(e){ localObj = {}; }
      const localStrNorm = JSON.stringify(localObj);
      const localHash = hashStr(localStrNorm);

      // If nothing changed, skip
      if(remoteHash === localHash || remoteHash === lastAppliedRemoteHash) return;

      // If user has unsaved local edits (dirty), keep a backup + warn in status
      if(dirty){
        backupLocalBeforeRemote();
        setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø± â€” ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.");
        setPill("â˜ï¸ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø±Ø¯", "warn");
      }else{
        setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© âœ…");
        setPill("â˜ï¸ Ù…ØªØµÙ„", "ok");
      }

      // Apply remote
      try{
        lastAppliedRemoteHash = remoteHash;
        window.dispatchEvent(new CustomEvent("pfm:apply", {detail: remoteData}));
        setLast(nowClock());
      }catch(e){
        console.error(e);
      }

    }, (err)=>{
      console.error(err);
      setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª âŒ (Rules/Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)");
      setPill("â˜ï¸ Ø®Ø·Ø£", "danger");
    });
  }

  function updateAuthUI(user){
    const signedIn = !!user;
    const creds = $("#cloudCreds");
    if(btnLogin)  btnLogin.style.display  = signedIn ? "none" : "inline-flex";
    if(btnLogout) btnLogout.style.display = signedIn ? "inline-flex" : "none";
    if(creds)     creds.style.display     = signedIn ? "none" : "grid";

    if(signedIn){
      setPill("â˜ï¸ Ù…ØªØµÙ„", "ok");
      const who = user.email ? `Ù…ØªØµÙ„: ${user.email}` : "Ù…ØªØµÙ„";
      setStatus(`Ø§Ù„Ø­Ø§Ù„Ø©: ${who}`);
    }else{
      setPill("â˜ï¸ ØºÙŠØ± Ù…ØªØµÙ„", "warn");
      setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù…ØªØµÙ„");
      setLast("â€”");
    }
  }

  // Login / Logout
  btnLogin?.addEventListener("click", async ()=>{
  const email = (emailEl?.value || "").trim();
  const pass  = (passEl?.value || "").trim();
  if(!email || !pass){ setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"); return; }

  if(btnLogin){ btnLogin.disabled = true; btnLogin.textContent = "Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„..."; }
  setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");

  // Timeout guard (sometimes network requests hang)
  const timeoutMs = 12000;
  const timeoutPromise = new Promise((_, reject)=> setTimeout(()=> reject({code:"timeout"}), timeoutMs));

  try{
    await Promise.race([
      auth.signInWithEmailAndPassword(email, pass),
      timeoutPromise
    ]);
  }catch(err){
    console.error(err);
    if(err && err.code === "timeout"){
      setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: Ù„Ù… ÙŠÙƒØªÙ…Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©) â³ â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª/Ø­Ø¸Ø± Ø®Ø¯Ù…Ø§Øª Google Ø£Ùˆ Ø¬Ø±Ù‘Ø¨ Ø´Ø¨ÙƒØ© Ø£Ø®Ø±Ù‰.");
      setPill("â˜ï¸ Ø®Ø·Ø£", "danger");
    }else{
      const code = err && err.code ? ` (${err.code})` : "";
      setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âŒ" + code);
      setPill("â˜ï¸ Ø®Ø·Ø£", "danger");
    }
  }finally{
    if(btnLogin){ btnLogin.disabled = false; btnLogin.textContent = "ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"; }
  }
});

  btnLogout?.addEventListener("click", async ()=>{
    try{ await auth.signOut(); }catch(e){}
  });

  // Optional manual buttons
  btnPull?.addEventListener("click", async ()=>{
    if(!auth.currentUser){ setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return; }
    const docRef = db.collection("pfm_users").doc(auth.currentUser.uid);
    setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ø±Ù Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...");
    try{
      const snap = await docRef.get();
      if(snap.exists){
        const remoteData = (snap.data()||{}).data || {};
        backupLocalBeforeRemote();
        window.dispatchEvent(new CustomEvent("pfm:apply", {detail: remoteData}));
        dirty = false;
        setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ØªÙ… Ø§Ù„Ø¬Ù„Ø¨ âœ…");
        setPill("â˜ï¸ Ù…ØªØµÙ„", "ok");
        setLast(nowClock());
      }else{
        setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ø¹Ø¯");
      }
    }catch(err){
      console.error(err);
      setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ÙØ´Ù„ Ø§Ù„Ø¬Ù„Ø¨ âŒ");
      setPill("â˜ï¸ Ø®Ø·Ø£", "danger");
    }
  });

  btnPush?.addEventListener("click", ()=> schedulePush("ÙŠØ¯ÙˆÙŠ"));

  // Restore last backup created before applying remote updates (if any)
  btnRestore?.addEventListener("click", ()=>{
    try{
      const raw = localStorage.getItem(BACKUP_KEY);
      if(!raw){ setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø¹Ø¯"); return; }
      const payload = JSON.parse(raw);
      if(payload && payload.data){
        window.dispatchEvent(new CustomEvent("pfm:apply", {detail: payload.data}));
        dirty = true;
        setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© âœ… (Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)");
        setPill("â˜ï¸ Ù…ØªØµÙ„", "ok");
        schedulePush("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©");
      }else{
        setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©");
      }
    }catch(e){
      console.error(e);
      setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© âŒ");
    }
  });


  // Autosave on local changes
  window.addEventListener("pfm:changed", ()=>{
    // Debounce push only if logged in
    dirty = true;
    if(!auth.currentUser) return;
    const cur = localString();
    if(cur === lastLocalStr) return;
    lastLocalStr = cur;
    schedulePush("ØªØºÙŠÙŠØ±");
  });

  // Online/offline hints
  window.addEventListener("online", ()=> {
    if(auth.currentUser){
      setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: Ø¹Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ âœ… Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹");
      setPill("â˜ï¸ Ù…ØªØµÙ„", "ok");
      schedulePush("Ø¹ÙˆØ¯Ø© Ø§ØªØµØ§Ù„");
    }
  });
  window.addEventListener("offline", ()=> {
    setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ù†ØªØ±Ù†Øª â€” Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„");
    setPill("â˜ï¸ Ø£ÙˆÙÙ„Ø§ÙŠÙ†", "warn");
  });

  // Auth state
  auth.onAuthStateChanged(async (user)=>{
    updateAuthUI(user);
    if(unsubSnap){ try{ unsubSnap(); }catch(e){} unsubSnap=null; }
    if(!user) return;

    const docRef = db.collection("pfm_users").doc(user.uid);

    // Ensure document exists then start realtime listener
    try{
      await ensureDoc(docRef);
      startRealtime(docRef);
      // First push to ensure cloud has latest (debounced)
      schedulePush("Ø¨Ø¯Ø¡");
    }catch(err){
      console.error(err);
      const code = err && err.code ? ` (${err.code})` : "";
      setStatus("Ø§Ù„Ø­Ø§Ù„Ø©: ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø­Ø§Ø¨Ø© âŒ" + code);
      setPill("â˜ï¸ Ø®Ø·Ø£", "danger");
    }
  });

})();
</script>

</body>
</html>
